name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            args: '--target x86_64-pc-windows-msvc'
            artifact-name: 'mushin-windows-x64'
            asset-name: 'mushin-windows-x64-setup.exe'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            args: '--target x86_64-apple-darwin'
            artifact-name: 'mushin-macos-x64'
            asset-name: 'mushin-macos-x64.dmg'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            args: '--target aarch64-apple-darwin'
            artifact-name: 'mushin-macos-arm64'
            asset-name: 'mushin-macos-arm64.dmg'
          - platform: 'ubuntu-latest'
            target: 'x86_64-unknown-linux-gnu'
            args: '--target x86_64-unknown-linux-gnu'
            artifact-name: 'mushin-linux-x64'
            asset-name: 'mushin-linux-x64.AppImage'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install frontend dependencies
        working-directory: app
        run: bun install

      - name: Build Next.js frontend
        working-directory: app
        run: bun run build

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build Tauri app
        working-directory: app
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: npm run tauri build -- ${{ matrix.args }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            app/src-tauri/target/${{ matrix.target }}/release/bundle/**/*
          if-no-files-found: error
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Debug workflow info
        run: |
          echo "GitHub Actor: ${{ github.actor }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "Tag Name: ${{ steps.tag.outputs.TAG_NAME }}"
          echo "GitHub Token (first 10 chars): ${GITHUB_TOKEN:0:10}..."
          
          # Get tag info to see who created it
          TAG_INFO=$(git show ${{ steps.tag.outputs.TAG_NAME }} --format="%an|%ae|%H" -s 2>/dev/null || echo "Tag not found in local repo")
          echo "Tag creator info: $TAG_INFO"
          
          # Check current user permissions
          USER_INFO=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user")
          echo "Current user: $(echo $USER_INFO | jq -r '.login')"
          echo "User type: $(echo $USER_INFO | jq -r '.type')"

      - name: Check if release exists
        id: check_release
        run: |
          EXISTING_RELEASE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.tag.outputs.TAG_NAME }}")
          
          if echo "$EXISTING_RELEASE" | jq -e '.id' > /dev/null 2>&1; then
            echo "Release already exists"
            echo "RELEASE_ID=$(echo $EXISTING_RELEASE | jq -r '.id')" >> $GITHUB_OUTPUT
            echo "UPLOAD_URL=$(echo $EXISTING_RELEASE | jq -r '.upload_url' | sed 's/{?name,label}//')" >> $GITHUB_OUTPUT
            echo "EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "Release does not exist, will create new one"
            echo "EXISTS=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Release
        id: create_release
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          # Create release using PAT token (has full repo permissions)
          RELEASE_RESPONSE=$(curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{\"tag_name\":\"${{ steps.tag.outputs.TAG_NAME }}\",\"name\":\"Release ${{ steps.tag.outputs.TAG_NAME }}\",\"body\":\"Automated release for ${{ steps.tag.outputs.TAG_NAME }}\",\"draft\":false,\"prerelease\":false}")
          
          # Check for author_id error specifically
          if echo "$RELEASE_RESPONSE" | jq -e '.errors[] | select(.field == "author_id")' > /dev/null 2>&1; then
            echo "::error::Author ID permission error detected!"
            echo ""
            echo "This error occurs when GitHub tries to use the tag author for the release."
            echo "To fix this, you need to configure repository permissions:"
            echo ""
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/actions"
            echo "2. Scroll to 'Workflow permissions'"
            echo "3. Select 'Read and write permissions'"
            echo "4. Click 'Save'"
            echo ""
            echo "Alternatively, ensure the tag was created by a user with push access."
            echo ""
            echo "Full error response:"
            echo "$RELEASE_RESPONSE" | jq '.'
            exit 1
          fi
          
          echo "Release response: $RELEASE_RESPONSE"
          
          # Check for errors
          if echo "$RELEASE_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error details:"
            echo "$RELEASE_RESPONSE" | jq '.errors'
            exit 1
          fi
          
          if echo "$RELEASE_RESPONSE" | jq -e '.message' > /dev/null 2>&1; then
            echo "Error message: $(echo $RELEASE_RESPONSE | jq -r '.message')"
            exit 1
          fi
          
          RELEASE_ID=$(echo $RELEASE_RESPONSE | jq -r '.id')
          UPLOAD_URL=$(echo $RELEASE_RESPONSE | jq -r '.upload_url' | sed 's/{?name,label}//')
          
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Error: Failed to create release or get upload URL"
            echo "Response: $RELEASE_RESPONSE"
            exit 1
          fi
          
          echo "Release ID: $RELEASE_ID"
          echo "Upload URL: $UPLOAD_URL"
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Get Upload URL
        id: get_upload_url
        run: |
          if [ "${{ steps.check_release.outputs.EXISTS }}" = "true" ]; then
            echo "UPLOAD_URL=${{ steps.check_release.outputs.UPLOAD_URL }}" >> $GITHUB_OUTPUT
          else
            echo "UPLOAD_URL=${{ steps.create_release.outputs.UPLOAD_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifacts
        run: |
          UPLOAD_URL="${{ steps.get_upload_url.outputs.UPLOAD_URL }}"
          echo "Upload URL: $UPLOAD_URL"
          
          # Upload artifacts
          find artifacts -type f | while read file; do
            filename=$(basename "$file")
            echo "Uploading $file as $filename"
            curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$file" \
              "$UPLOAD_URL?name=$filename"
          done

